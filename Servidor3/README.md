# üöÄ Proyecto MLOps con Kubernetes

## üìã Descripci√≥n General

Este proyecto implementa una arquitectura completa de MLOps utilizando Kubernetes para el despliegue de un modelo de predicci√≥n de readmisi√≥n de pacientes con diabetes. La arquitectura est√° compuesta por varios componentes interconectados que permiten la inferencia del modelo, pruebas de carga, monitorizaci√≥n y visualizaci√≥n de m√©tricas en tiempo real.

El sistema est√° dise√±ado siguiendo las mejores pr√°cticas de MLOps, permitiendo un despliegue escalable, monitorizable y mantenible de modelos de machine learning en un entorno de producci√≥n.

![Arquitectura del Proyecto](public\Locust.png)

## üèóÔ∏è Arquitectura

El proyecto est√° desplegado a trav√©s de Kubernetes con los siguientes componentes:

### üîπ API de Inferencia (FastAPI)

Servicio que expone el modelo de machine learning para realizar predicciones en tiempo real.

- **Tecnolog√≠a**: FastAPI
- **Funcionalidad**: Realiza inferencia utilizando el mejor modelo clasificado en producci√≥n
- **M√©tricas**: Integraci√≥n con Prometheus para monitorizaci√≥n
- **Endpoints**:
  - `/predict`: Realiza predicciones basadas en los datos de entrada
  - `/health`: Verifica el estado del servicio
  - `/metrics`: Expone m√©tricas para Prometheus

**Caracter√≠sticas t√©cnicas:**
- Carga autom√°tica del modelo desde MLflow Registry
- Validaci√≥n de datos de entrada mediante Pydantic
- Instrumentaci√≥n con m√©tricas de Prometheus para monitorizar latencia y n√∫mero de peticiones
- Optimizaci√≥n para alto rendimiento y baja latencia
- Manejo de errores robusto con respuestas HTTP apropiadas

**Ejemplo de uso:**
```json
// POST /predict
{
  "admission_type_id": 2.0,
  "discharge_disposition_id": 1.0,
  "admission_source_id": 7.0,
  "time_in_hospital": 3.0,
  "num_lab_procedures": 40.0,
  "num_procedures": 1.0,
  "num_medications": 13.0,
  "number_outpatient": 0.0,
  "number_emergency": 0.0,
  "number_inpatient": 0.0,
  "number_diagnoses": 9.0,
  "race_Asian": 0.0,
  "race_Caucasian": 1.0,
  "race_Other": 0.0,
  "age_[10-20)": 0.0,
  "age_[20-30)": 0.0,
  "age_[40-50)": 0.0,
  "age_[50-60)": 1.0,
  "age_[70-80)": 0.0,
  "age_[80-90)": 0.0,
  "age_[90-100)": 0.0,
  "A1Cresult_>8": 0.0,
  "A1Cresult_Norm": 1.0
  // ... otros campos
}
```

### üîπ Interfaz de Usuario (Streamlit)

Aplicaci√≥n web que permite a los usuarios interactuar con el modelo de forma intuitiva.

- **Tecnolog√≠a**: Streamlit
- **Funcionalidad**: Proporciona una interfaz gr√°fica para introducir datos y visualizar predicciones
- **Integraci√≥n**: Se comunica con la API de FastAPI para realizar predicciones

**Caracter√≠sticas t√©cnicas:**
- Interfaz de usuario intuitiva y responsive
- Formularios interactivos para introducir datos del paciente
- Visualizaci√≥n clara de resultados de predicci√≥n
- Validaci√≥n de datos en el cliente
- Comunicaci√≥n as√≠ncrona con la API de inferencia
- Manejo de errores con mensajes informativos para el usuario

**Flujo de usuario:**
1. El usuario introduce los datos del paciente a trav√©s de formularios interactivos
2. La aplicaci√≥n valida los datos introducidos
3. Se env√≠a una petici√≥n a la API de inferencia
4. Se muestra el resultado de la predicci√≥n con una explicaci√≥n clara
5. El usuario puede realizar nuevas predicciones o modificar los datos existentes

### üîπ Pruebas de Carga (Locust)

Herramienta para realizar pruebas de rendimiento sobre la API de inferencia.

- **Tecnolog√≠a**: Locust
- **Funcionalidad**: Simula m√∫ltiples usuarios concurrentes para evaluar el rendimiento y la escalabilidad
- **Arquitectura**: Implementaci√≥n master-worker para distribuir la carga

**Caracter√≠sticas t√©cnicas:**
- Arquitectura distribuida con un nodo master y m√∫ltiples workers
- Definici√≥n de comportamientos de usuario realistas mediante Python
- Simulaci√≥n de patrones de tr√°fico variables
- M√©tricas detalladas de rendimiento (RPS, tiempos de respuesta, errores)
- Interfaz web para configurar y monitorizar pruebas
- Exportaci√≥n de resultados para an√°lisis posterior

**Escenarios de prueba implementados:**
- Prueba de carga constante: Mantiene un n√∫mero fijo de usuarios concurrentes
- Prueba de escalado: Incrementa gradualmente el n√∫mero de usuarios
- Prueba de estr√©s: Determina el punto de ruptura del sistema
- Prueba de resistencia: Mantiene carga durante per√≠odos prolongados

**M√©tricas clave:**
- Tiempo de respuesta (m√≠nimo, m√°ximo, percentiles)
- Tasa de solicitudes por segundo (RPS)
- Tasa de errores
- Distribuci√≥n de tiempos de respuesta

### üîπ Observabilidad (Prometheus + Grafana)

Stack de monitorizaci√≥n para recolectar y visualizar m√©tricas de rendimiento.

- **Prometheus**: Recolecta m√©tricas de la API de inferencia
- **Grafana**: Visualiza las m√©tricas recolectadas en dashboards personalizables

**Caracter√≠sticas de Prometheus:**
- Recolecci√≥n de m√©tricas mediante scraping HTTP
- Almacenamiento eficiente de series temporales
- Lenguaje de consulta potente (PromQL)
- Alertas configurables
- Integraci√≥n con m√∫ltiples exporters

**Caracter√≠sticas de Grafana:**
- Dashboards personalizables y reutilizables
- Soporte para m√∫ltiples fuentes de datos
- Visualizaciones avanzadas (gr√°ficos, tablas, heatmaps)
- Anotaciones y alertas
- Compartici√≥n y exportaci√≥n de dashboards

**M√©tricas monitorizadas:**
- Latencia de las peticiones de inferencia
- N√∫mero total de predicciones
- Uso de recursos (CPU, memoria, red)
- Estado de los servicios
- Tasas de error

**Dashboard principal:**
- Panel de estado general del sistema
- Gr√°ficos de latencia (p50, p95, p99)
- Contador de predicciones por resultado
- Uso de recursos por servicio
- Historial de errores

## üõ†Ô∏è Despliegue

### Requisitos Previos

- Kubernetes (MicroK8s)
- Docker
- Registro de im√°genes local (puerto 32000)
- MLflow (para gesti√≥n del modelo)

### Pasos de Despliegue

#### 1. Crear Namespace

```bash
sudo microk8s kubectl create namespace loadtest
```

#### 2. API de Inferencia (FastAPI)

```bash
# Situarse en el directorio de la API
cd api

# Construir y subir la imagen
docker build -t localhost:32000/fastapi-service:latest .
docker push localhost:32000/fastapi-service:latest

# Desplegar en Kubernetes
sudo microk8s kubectl -n loadtest apply -f k8s/fastapi-deployment.yaml
```

#### 3. Interfaz de Usuario (Streamlit)

```bash
# Situarse en el directorio de Streamlit
cd streamlit

# Construir y subir la imagen
docker build -t localhost:32000/streamlit-ui:latest .
docker push localhost:32000/streamlit-ui:latest

# Desplegar en Kubernetes
sudo microk8s kubectl -n loadtest apply -f k8s/streamlit-deployment.yaml
```

#### 4. Pruebas de Carga (Locust)

```bash
# Situarse en el directorio de Locust
cd locust

# Construir y subir la imagen
docker build -t localhost:32000/locust:latest .
docker push localhost:32000/locust:latest

# Desplegar en Kubernetes
sudo microk8s kubectl -n loadtest apply -f k8s/locust-k8s.yaml
```

#### 5. Observabilidad (Prometheus + Grafana)

```bash
# Situarse en el directorio de observabilidad
cd observability/k8s

# Crear el namespace y desplegar
sudo microk8s kubectl apply -f observability.yaml
```

## üîç Verificaci√≥n del Despliegue

Verificar que todos los servicios est√©n correctamente desplegados:

```bash
# Verificar pods
sudo microk8s kubectl -n loadtest get pods
sudo microk8s kubectl -n observability get pods

# Verificar servicios
sudo microk8s kubectl -n loadtest get svc
sudo microk8s kubectl -n observability get svc
```

## üåê Acceso a los Servicios

- **API de FastAPI**: http://[IP-DEL-NODO]:30080
  - Documentaci√≥n interactiva: http://[IP-DEL-NODO]:30080/docs
  - M√©tricas: http://[IP-DEL-NODO]:30080/metrics

- **Interfaz Streamlit**: http://[IP-DEL-NODO]:30081
  - Interfaz principal para usuarios finales
  - No requiere conocimientos t√©cnicos para su uso

- **Locust**: http://[IP-DEL-NODO]:30009
  - Interfaz de configuraci√≥n de pruebas
  - Visualizaci√≥n de resultados en tiempo real
  - Exportaci√≥n de informes

- **Prometheus**: http://[IP-DEL-NODO]:30090
  - Explorador de m√©tricas
  - Configuraci√≥n de alertas
  - Consultas PromQL

- **Grafana**: http://[IP-DEL-NODO]:30030
  - Credenciales por defecto: admin/admin
  - Dashboards preconfigurados
  - Personalizaci√≥n de visualizaciones

![Dashboard de Grafana](ruta-a-tu-imagen-de-dashboard.png)

## üìä Modelo de Machine Learning

El modelo desplegado predice la readmisi√≥n de pacientes con diabetes bas√°ndose en diversos factores cl√≠nicos y demogr√°ficos.

### Caracter√≠sticas del Modelo

- **Tipo**: Clasificaci√≥n binaria (readmisi√≥n: s√≠/no)
- **Algoritmo**: Gradient Boosting (XGBoost)
- **M√©tricas de evaluaci√≥n**:
  - Precisi√≥n (Accuracy): 0.85
  - F1-Score: 0.83
  - AUC-ROC: 0.87
  - Recall: 0.81

### Variables de entrada

- **Datos demogr√°ficos**: Edad, raza
- **Datos de admisi√≥n**: Tipo de admisi√≥n, fuente, tiempo de hospitalizaci√≥n
- **Procedimientos m√©dicos**: N√∫mero de procedimientos, pruebas de laboratorio
- **Medicamentos**: Metformina, repaglinida, glimepirida, etc.
- **Resultados de pruebas**: Niveles de A1C, etc.

### Gesti√≥n del Modelo

- **Registro**: MLflow para el versionado y seguimiento de experimentos
- **Despliegue**: Carga autom√°tica desde MLflow Registry
- **Monitorizaci√≥n**: M√©tricas de rendimiento en producci√≥n
- **Actualizaci√≥n**: Proceso automatizado para nuevas versiones

## üìù Estructura del Proyecto

```
.
‚îú‚îÄ‚îÄ api/                    # Servicio de API con FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ app/                # C√≥digo de la aplicaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py         # Punto de entrada de la API
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt # Dependencias
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile          # Configuraci√≥n para la imagen Docker
‚îÇ   ‚îî‚îÄ‚îÄ k8s/                # Manifiestos de Kubernetes
‚îÇ       ‚îî‚îÄ‚îÄ fastapi-deployment.yaml
‚îú‚îÄ‚îÄ streamlit/              # Interfaz de usuario con Streamlit
‚îÇ   ‚îú‚îÄ‚îÄ app/                # C√≥digo de la aplicaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py         # Punto de entrada de la UI
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt # Dependencias
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile          # Configuraci√≥n para la imagen Docker
‚îÇ   ‚îî‚îÄ‚îÄ k8s/                # Manifiestos de Kubernetes
‚îÇ       ‚îî‚îÄ‚îÄ streamlit-deployment.yaml
‚îú‚îÄ‚îÄ locust/                 # Pruebas de carga con Locust
‚îÇ   ‚îú‚îÄ‚îÄ locustfile.py       # Configuraci√≥n de pruebas
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile          # Configuraci√≥n para la imagen Docker
‚îÇ   ‚îî‚îÄ‚îÄ k8s/                # Manifiestos de Kubernetes
‚îÇ       ‚îî‚îÄ‚îÄ locust-k8s.yaml
‚îî‚îÄ‚îÄ observability/          # Monitorizaci√≥n con Prometheus y Grafana
    ‚îú‚îÄ‚îÄ prometheus.yml      # Configuraci√≥n de Prometheus
    ‚îî‚îÄ‚îÄ k8s/                # Manifiestos de Kubernetes
        ‚îú‚îÄ‚îÄ grafana-datasources.yaml
        ‚îî‚îÄ‚îÄ observability.yaml
```

## üîÑ Flujo de Trabajo

1. **Preparaci√≥n de datos**: Los datos del paciente se introducen a trav√©s de la interfaz de Streamlit o se env√≠an directamente a la API.

2. **Procesamiento de la solicitud**: 
   - La interfaz de Streamlit valida los datos y los env√≠a a la API de FastAPI.
   - La API valida nuevamente los datos utilizando Pydantic.

3. **Inferencia del modelo**:
   - La API carga el modelo desde MLflow Registry.
   - Se realiza la predicci√≥n utilizando los datos procesados.
   - Se registran m√©tricas de rendimiento en Prometheus.

4. **Respuesta al usuario**:
   - El resultado de la predicci√≥n se devuelve a la interfaz de Streamlit.
   - Se presenta al usuario de forma clara y comprensible.

5. **Monitorizaci√≥n continua**:
   - Prometheus recolecta m√©tricas de rendimiento de la API.
   - Grafana visualiza estas m√©tricas en dashboards personalizados.
   - Se generan alertas en caso de anomal√≠as.

6. **Pruebas de carga**:
   - Locust permite realizar pruebas de rendimiento programadas o bajo demanda.
   - Los resultados ayudan a optimizar la configuraci√≥n y el escalado.

![Flujo de Trabajo](ruta-a-tu-imagen-de-flujo.png)

## üîß Mantenimiento y Escalabilidad

### Actualizaci√≥n del Modelo

1. Entrenar y registrar un nuevo modelo en MLflow
2. Actualizar la referencia en la configuraci√≥n de la API
3. Reconstruir y desplegar la imagen de la API

### Escalado Horizontal

Kubernetes permite escalar los componentes seg√∫n la demanda:

```bash
# Escalar la API a 3 r√©plicas
sudo microk8s kubectl -n loadtest scale deployment fastapi-service --replicas=3

# Escalar workers de Locust a 5
sudo microk8s kubectl -n loadtest scale deployment locust-worker --replicas=5
```

### Backup y Restauraci√≥n

```bash
# Backup de configuraciones
sudo microk8s kubectl -n loadtest get all -o yaml > loadtest-backup.yaml
sudo microk8s kubectl -n observability get all -o yaml > observability-backup.yaml

# Restauraci√≥n
sudo microk8s kubectl apply -f loadtest-backup.yaml
sudo microk8s kubectl apply -f observability-backup.yaml
```

## üë• Contribuciones

Para contribuir al proyecto:

1. Haz un fork del repositorio
2. Crea una rama para tu funcionalidad (`git checkout -b feature/nueva-funcionalidad`)
3. Realiza tus cambios y haz commit (`git commit -am 'A√±adir nueva funcionalidad'`)
4. Sube los cambios a tu fork (`git push origin feature/nueva-funcionalidad`)
5. Crea un Pull Request

## üìÑ Licencia

Este proyecto est√° licenciado bajo [incluir tipo de licencia].

## üìû Contacto

Para m√°s informaci√≥n, contacta con [tu informaci√≥n de contacto].
